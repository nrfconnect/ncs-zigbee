name: Cleanup PR preview

on:
  workflow_run:
    workflows: ["PR closed"]
    types:
      - completed

permissions:
  contents: read
  pages: write
  id-token: write
  actions: write

# Use same concurrency group as deploy to avoid conflicts
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  cleanup:
    runs-on: ubuntu-24.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: github-pages

    steps:
      - name: Download PR info artifact
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: post_pr.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: pr-closed-info

      - name: Read PR info
        id: pr-info
        run: |
          PR_NUMBER=$(cat pr_number.txt | tr -cd '0-9')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR number: $PR_NUMBER"

      - name: Download current site state from deploy workflow
        id: download-state
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: deploy_doc_to_pages.yml
          name: site-state
          path: _site
          workflow_conclusion: success
          search_artifacts: true
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Try cleanup workflow for site state
        id: download-state-cleanup
        if: steps.download-state.outcome == 'failure'
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 # v6
        with:
          workflow: cleanup_preview.yml
          name: site-state
          path: _site
          workflow_conclusion: success
          search_artifacts: true
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Verify site state exists
        run: |
          if [ ! -d "_site" ] || [ -z "$(ls -A _site 2>/dev/null)" ]; then
            echo "Error: Could not download site-state artifact from any workflow"
            echo "This may happen if no documentation has been deployed yet"
            exit 1
          fi
          echo "Site state downloaded successfully"
          ls -la _site/

      - name: Remove PR preview directory
        id: cleanup
        run: |
          pr_number="${{ steps.pr-info.outputs.pr_number }}"
          preview_dir="_site/pr-preview/pr-${pr_number}"

          if [ -d "$preview_dir" ]; then
            echo "Removing preview directory: $preview_dir"
            rm -rf "$preview_dir"

            # Check if pr-preview directory is empty and remove if so
            if [ -d "_site/pr-preview" ] && [ -z "$(ls -A _site/pr-preview)" ]; then
              rm -rf "_site/pr-preview"
            fi

            echo "cleaned_up=true" >> $GITHUB_OUTPUT
            echo "Preview cleaned up successfully"
          else
            echo "No preview directory found for PR #${pr_number}"
            echo "cleaned_up=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Pages
        if: steps.cleanup.outputs.cleaned_up == 'true'
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5

      - name: Upload Pages artifact
        if: steps.cleanup.outputs.cleaned_up == 'true'
        uses: actions/upload-pages-artifact@0252fc4ba7626f0298f0cf00902a25c6afc77fa8 # v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        if: steps.cleanup.outputs.cleaned_up == 'true'
        uses: actions/deploy-pages@f33f41b675f0ab2dc5a6863c9a170fe83af3571e # v4

      # Save updated site state
      - name: Save site state artifact
        if: steps.cleanup.outputs.cleaned_up == 'true'
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4
        with:
          name: site-state
          path: _site
          retention-days: 90
          overwrite: true
