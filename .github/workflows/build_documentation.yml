name: Build documentation (PR validation)

on:
  pull_request_target:
    branches:
      - main
    paths:
      - 'docs/**'

# Sets permissions to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  pull-requests: write

concurrency:
  group: "docs-preview-${{ github.event.pull_request.number }}"
  cancel-in-progress: true

jobs:
  Build_Documentation:
    runs-on: ubuntu-24.04
    outputs:
      changed_docs: ${{ steps.changed-files.outputs.docs_files }}
      preview_url: ${{ steps.deploy-info.outputs.preview_url }}
      build_timestamp: ${{ steps.deploy-info.outputs.build_timestamp }}
      commit_sha: ${{ steps.deploy-info.outputs.commit_sha_short }}

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Checkout the PR head commit to build the actual PR changes
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get changed documentation files
        id: changed-files
        uses: ./.github/actions/get-changed-docs
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r docs/requirements-doc.txt

      - name: Install Doxygen and mscgen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen mscgen

      - name: Build Doxygen API documentation
        run: |
          cd docs
          if [ -f Doxyfile ]; then
            doxygen Doxyfile
          fi

      - name: Build Sphinx documentation
        run: |
          cd docs
          sphinx-build -M html . _build_sphinx -W --keep-going

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-preview
          path: docs/_build_sphinx/html/
          retention-days: 7

      - name: Deploy preview to gh-pages branch
        uses: ./.github/actions/deploy-docs-preview
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          pr_number: ${{ github.event.pull_request.number }}
          commit_sha: ${{ github.event.pull_request.head.sha }}

      - name: Set preview URL and timestamp
        id: deploy-info
        uses: ./.github/actions/set-deploy-info
        with:
          repo_owner: ${{ github.repository_owner }}
          repo_name: ${{ github.event.repository.name }}
          pr_number: ${{ github.event.pull_request.number }}
          commit_sha: ${{ github.event.pull_request.head.sha }}

  Post_Comment:
    needs: Build_Documentation
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate comment body
        uses: ./.github/actions/generate-docs-comment
        with:
          preview_url: ${{ needs.Build_Documentation.outputs.preview_url }}
          changed_docs: ${{ needs.Build_Documentation.outputs.changed_docs }}
          build_timestamp: ${{ needs.Build_Documentation.outputs.build_timestamp }}
          commit_sha: ${{ needs.Build_Documentation.outputs.commit_sha }}

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Documentation Preview'

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comment.md
          edit-mode: replace
